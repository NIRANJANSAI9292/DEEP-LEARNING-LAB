import tensorflow as tf
import tensorflow_datasets as tfds
import matplotlib.pyplot as plt

# 1. Load more data for better training (50% train, 10% test)
splits = ['train[:50%]', 'train[50:60%]']
datasets, info = tfds.load('cats_vs_dogs',
                          split=splits,
                          as_supervised=True,
                          with_info=True)
train, test = datasets[0], datasets[1]

# 2. Preprocess images: resize and normalize
def process(image, label):
    image = tf.image.resize(image, (128, 128))
    image = image / 255.0
    return image, label

train = train.map(process).batch(32).shuffle(1000)
test = test.map(process).batch(32)

# 3. Build a slightly bigger CNN model
model = tf.keras.Sequential([
    tf.keras.layers.Conv2D(32, 3, activation='relu', input_shape=(128, 128, 3)),
    tf.keras.layers.MaxPooling2D(),

    tf.keras.layers.Conv2D(64, 3, activation='relu'),
    tf.keras.layers.MaxPooling2D(),

    tf.keras.layers.Flatten(),
    tf.keras.layers.Dense(64, activation='relu'),
    tf.keras.layers.Dense(1, activation='sigmoid')
])

# 4. Compile model
model.compile(optimizer='adam',
              loss='binary_crossentropy',
              metrics=['accuracy'])

# 5. Train model for 5 epochs
model.fit(train, epochs=5, validation_data=test)

# 6. Show one test image with prediction
for images, labels in test.take(1):
    img = images[0].numpy()
    true_label = labels[0].numpy()

    img_expanded = tf.expand_dims(img, 0)
    prediction = model.predict(img_expanded)[0][0]

    pred_label = "Dog" if prediction > 0.5 else "Cat"
    true_label_name = "Dog" if true_label == 1 else "Cat"

    plt.imshow(img)
    plt.title(f"Predicted: {pred_label}\nTrue: {true_label_name}")
    plt.axis('off')
    plt.show()
